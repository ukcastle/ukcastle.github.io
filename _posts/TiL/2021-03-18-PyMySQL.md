---
layout: post
title: pymysql 사용하기
category: TiL
tag: [Python, pymysql, mySQL]  
---

#### pymysql

pymysql은 직관적으로 Python에서 mysql을 사용하기 위한 모듈이다.  
많은 예제가 있고, 소스코드도 많지만 각자 코드를 쓰는 방식이 모두 다르다.  
사용법은 가장 기본적으로만 쓰고, sql 쿼리문은 `INSERT`문 한개만 쓰겠다.  
이 글은 나의 코딩 방식만을 위주로 쓸 방식이다.

#### Class 생성

```Python   

import pymysql
from pymysql.connections import Connection

class MySQL:

    def __init__(self, user, passwd, host, db, charset='utf8'):
        self.__user = user
        self.__passwd = passwd
        self.__host = host
        self.__db = db
        self.__charset = charset
        self.__conn : Connection = None
```

가장 기본적인 생성자이다.  
`Connection`은 None으로 둔 상태로 둔다.  
모든 멤버변수는 private 변수로 선언해준다.  

```python
    def __connect(self):
        if self.__conn is None:
            self.__conn = pymysql.connect(
                            user = self.__user, 
                            passwd = self.__passwd,
                            host = self.__host,
                            db = self.__db,
                            charset = self.__charset)

    def __disconnect(self):
        if self.__conn is not None:
            self.__conn.close()
```

connection 멤버변수에 실제로 연결 상태를 저장해둔다.  
db는 각 세션마다 만료도 있고, 최대 연결 제한도 있다.  
그래서 안정적으로 연결과 종료를 하기 위해 이 함수들도 private하게 구현하고 다른 메소드에서 사용한다.  

```python
    def insertTable(self, arg1, arg2, arg3, tableName = "status"):
        try:
            self.__connect()
            self.__insertStatus(arg1, arg2, arg3, tableName)
        
        except Exception as e:
            logger.error(e)
            logger.exception(e)
        
        finally:
            self.__disconnect()

    def __insertStatus(self, arg1, arg2, arg3, tableName):
        cursor = self.__conn.cursor()
        # column: col1 : String, col2 : Integer, col3 : Float
        query = f"""
        INSERT INTO {tableName} (col1, col2, col3) 
        VALUES ("{arg1}",{arg2},{arg3})
        """
        cursor.execute(query)
        self.__conn.commit()
```

`__insertTable` 은 좀 더 낮은 레벨에서 쿼리문만을 처리하는 함수이고  
`insertTable` 은 내부적으로 `__insertTable`을 호출하며 connect와 disconnect를 관리하는 함수다.  
`try except` 문으로 쿼리를 실행하고 `finally`로 무조건 disconnect가 실행되게 한다.  

문자열 포맷팅방식에서 `s = f"문자열 {변수} "` 방식은 파이썬 3.6 이후로 지원하는 방식인데, 문자열 포맷팅 방식 3가지중 가장 빠르고 편한 방식이다. 사용하자.  


#### 고민해본 점 

GO 를 공부하다보니, 함수를 매개변수로 받는 방식도 꽤나 좋은 유연성을 제공한다고 생각한다.  

또한 SQL의 쿼리 함수들은 모두 `connect()`와 `disconnect()`를 사용한다.  
그렇다면 모든 쿼리 함수들을 하나의 인터페이스로 만든 다음 `connect()`와 `disconnect()`를 한번에 적용할 수 있게 한다면 더 편하지 않을까?  

다음에 한번 해봐야겠다.  